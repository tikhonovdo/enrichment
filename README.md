# FinancePM enrichment

Программа позволяет удобно и быстро осуществлять пакетное внесение данных 
в приложение [FinancePM](https://play.google.com/store/apps/details?id=com.finperssaver&hl=ru&gl=US)
с использованием выписки из личного кабинета [Тинькофф](https://tinkoff.ru/login/)
и их полуавтоматической обработки.

## Как пользоваться программой
1. [Подготовить исходный файл](#1---)
2. [Подготовить маппинг счетов](#2---)
3. [Подготовить маппинг категорий](#3---)
4. [Экспорт из FinancePM](#4---)
5. [Запуск](#5-)

### 1. Подготовить исходный файл 
> Программа проверялась на xls файле, сконвертированном в csv
(так сохранялась правильная кодировка на Mac).

1.1) Выгрузить данные по транзакциям по месяцам. Это сделать на вкладке **События** в личном кабинете [Tinkoff.ru](https://tinkoff.ru)
   
1.2) После выгрузки можно вносить в документ желаемые правки:
- Столбец **Категория** сначала будет пытаться матчиться с именем категории в FinancePM - 
если оно существует, то произойдет матчинг по нему. Иначе см. [подготовку маппинга категорий](#3---).
- Столбец **Описание** будет полностью перенесен в имя транзакции FinancePM

1.3) После сохранения в CSV, следует заменить строку заголовка на это:
```
operationDate;paymentDate;cardNumber;status;operationSum;operationCurrency;paymentSum;paymentCurrency;cashback;category;mcc;description;totalBonuses;roundingForInvestKopilka;sumWithRoundingForInvestKopilka
```

### 2. Подготовить маппинг счетов
Для привязки данных из выгрузки к кошелькам в FinancePM следует создать csv-файл
`account-mapping.csv` c использованием следующих ключей:
- `cardNumber` - номер карт/счетов/других идентификаторов из csv файла
- `financePmAccountId` - идентификаторы в FinancePM data-файле

Следует иметь в виду, что в выгрузке банка для некоторых операций перевода иногда 
не указывается номер карты, что соотвествует дебетовому счету.

> _Важно:_ нужно обязательно заполнить дефолтный вариант для пустого `cardNumber`, 
чтобы у транзакции всегда была привязка к счету - иначе документ в FinancePM будет считаться 
> невалидным.
> 
> Выглядеть это может так:
```
cardNumber;financePmAccountId
;666
```

Для ускорения создания файла можно выполнить программу с ключом `--init-mappings`,
который выведет данные из data-файла в формате, готовом для редактирования:
```
./gradlew bootRun --args='financePM_test.data --init-mappings'
```

### 3. Подготовить маппинг категорий
Программа умеет производить многоступенчатый маппинг по категориям, 
в зависимости от заранее заданных правил. Для их задания служит csv-файл `categories-mapping.csv`.
По умолчанию маппниг ведется по имени категории из CSV. Если соотвествие не найдено, 
то начинается прогон по алгоритму ниже.  

В нём используются следюущие ключи:
1. `financePmCategoryId` - идентификатор категории в FinancePM
2. `financePmCategoryType` - тип категории доходности в FinancePM: доход (1) или расход(2)
3. `financePmCategoryName` - имя категории в FinancePM
4. `mcc` _(опционально)_ - MCC-код операции, который должен быть у строки Тинькофф,
   чтобы транзакция была отнесена к указанной категории FinancePM.
   > _Используется в первую очередь_, если маппинг по [имени категории из исходного документа](#1---) не удался.

     Если `mcc` не указан, будет попытка подбора по `tinkoffDescriptionPart`, иначе транзакция
   будет отнесена к категории **Другое**.
5. `tinkoffDescriptionPart` _(опционально)_ - подстрока в описании транзакции, 
которая должна присутствовать, чтобы транзакция была отнесена к указанной 
категории FinancePM.
    > _Проверяется после `mcc`_, если маппинг по нему не задан.
   
    Если `tinkoffDescriptionPart` не указан, будет попытка подбора по `mcc`, в противном сулчае транзакция
будет отнесена к категории **Другое**.

Для ускорения создания файла можно выполнить программу с ключом `--init-mappings`,
который выведет данные из data-файла в формате, готовом для редактирования:
```
./gradlew bootRun --args='financePM_test.data --init-mappings'
```

### 4. Экспорт из FinancePM
Исходный файл для работы можно получить из меню 
> **Настройки** - **Экспорт & Импорт** - **Экспорт**

Полученный файл следует разместить в корневой директории проекта.

### 5. Запуск
```
./gradlew bootRun --args='financePM_test.data operations.csv [operations_2.csv operations_3.csv]'
```
После завершения работы будет создан файл вида `financePM_dd-MM-yyyy_enriched.data`, который следует импортировать в FinancePM.

**Сведения вам дебета с кредитом! :)**