## transactionMatchingStep

### Стандартный флоу работы
Для всех записей из таблицы <u>draft_transaction</u>, у которых
* `matching.category.category_id != null`, для соответствующего `bank_id != null`,
* `matching.currency.currency_id != null`, для соответствующего `bank_id != null`,
* `matching.account.account_id != null`, для соответствующего `bank_id != null`

выполнить разбор и вставку результатов в таблицу <u>transaction</u>
в соответствии с правилами матчинга:

| `financepm.transaction` | `matching.draft_transaction`                                                |
|-------------------------|-----------------------------------------------------------------------------|
| name                    | Описание операции                                                           |
| type                    | Доход/расход (1 или 2 соответственно)                                       |
| category_id             | `matching.category.category_id`, соответствующий маппингу конкретного Банка |
| date                    | Дата операции (допустимо с точностью до дня)                                |
| sum                     | Сумма операции в валюте Счета                                               |
| account_id              | `matching.account.account_id`, соответствующий маппингу конкретного Банка   |
| description             | Комментарий к операции                                                      |
| event_id                | `null` (для новых записей)                                                  |
| bank_id                 | id Банка, над записью котрого выполняется операция                          |

Повторить процедуру для каждого Банка.

#### Поле `financepm.transaction.bank_id`
Служит для различения данных из дата-файла и банковских выписок в таблице _financepm.transaction_: 
непустое значение свидетельствует о том, что запись импортирована из банковской выписки 
и её следует учесть при последующих прогонах матчинга, чтобы не создавать дубликат.
```
TODO: Также стоит обдумать возможность обогащения записей из FinancePM значениями полей name 
и description при совпадении по type, category_id, date, sum, account_id (стоит завести индекс?) данными 
от Банка. Мотивация - избежать возможных дубликатов при матчинге, которые уже были созданы в FinancePM.
```

### Флоу работы для Тинькофф
##### Категория "Наличные" - todo (ready to develop)
Для выборки не использовать записи с категорией "Наличные" - фактически это перевод
на счет, представляющий карманные деньги (предполагаю, что такой счет есть всегда),
который надо обработать как создание перевода.

##### Категория "Переводы" - todo (ready for testing)
Для записей с категорией "Переводы" необходимо сначала проверить, не являются ли они по сути расходом
с помощью таблицы `matching.category`. Если соответствия в ней найдено не было - создать новую запись 
в `financepm.transaction` с параметрами:
- _category_id_ = null
- _event_id_ = 1
и предпринимаем попытку сматчить их [в переводы](./transfer_matching.md) на соответствующем шаге.


### Альтернативный флоу работы
В случае невозможности сматчить транзацкии в соотвествии с данными из таблиц
- `matching.account`,
- `matching.category`,
- `matching.currency`, 

следует добавить информацию о таких транзакциях в таблицу `matching.transaction`, которая полностью повторяет 
структуру таблицы `financepm.transaction`, но ни одно поле в ней не является в ней обязательным, 
а также есть флаг фиксирования записи в таблице `financepm.transaction`. 

Добавлению в `matching.transaction` подлежат только записи, которых нет по ключу:
- bank_id
- type
- category_id (nullable)
- date
- sum
- account_id (nullable)

При наличии полного совпадения по этим полям запись не добавляется.

После ручного внесения изменений и последующей проверки в рамках работы шага,
записи из `manual_transaction` попадают в `transaction` с отметкой о добавлении в последнюю - 
такие записи более не будут экспортироваться `transaction`.


А МОЖЕТ ОТКАЗАТЬСЯ НАФИГ ОТ manual_transaction?
Просто сделать account_id nullable и не разрешать импорт таких записей в итоговый файл.
upd: пока сделал так


matching.account_tinkoff служит для матчинга счетов транзакций у которых они по каким