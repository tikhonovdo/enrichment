## transactionMatchingStep

### Стандартный флоу работы
Для всех записей из таблицы <u>draft_transaction</u>, у которых
* `category_matching.category_id != null`, для соответствующего `bank_id != null`,
* `currency_matching.currency_id != null`, для соответствующего `bank_id != null`,
* `account_matching.account_id != null`, для соответствующего `bank_id != null`

выполнить разбор и вставку результатов в таблицу <u>transaction</u>
в соответствии с правилами матчинга:

| `transaction` | `draft_transaction`                                                         |
|---------------|-----------------------------------------------------------------------------|
| name          | Описание операции                                                           |
| type          | Доход/расход (1 или 2 соответственно)                                       |
| category_id   | `category_matching.category_id`, соответствующий маппингу конкретного Банка |
| date          | Дата операции (допустимо с точностью до дня)                                |
| sum           | Сумма операции в валюте Счета                                               |
| account_id    | `account_matching.account_id`, соответствующий маппингу конкретного Банка   |
| description   | Комментарий к операции                                                      |
| event_id      | `null` (для новых записей)                                                  |
| bank_id       | id Банка, над записью котрого выполняется операция                          |

Повторить процедуру для каждого Банка.

#### Поле `transaction.bank_id`
Служит для различения данных из дата-файла и банковских выписок в таблице _transaction_: 
непустое значение свидетельствует о том, что запись импортирована из банковской выписки 
и её следует учесть при последующих прогонах матчинга, чтобы не создавать дубликат.
```
TODO: Также стоит обдумать возможность обогащения записей из FinancePM значениями полей name 
и description при совпадении по type, category_id, date, sum, account_id (стоит завести индекс?) данными 
от Банка. Мотивация - избежать возможных дубликатов при матчинге, которые уже были созданы в FinancePM.
```

#### Тинькофф
Для выборки не использовать записи с категориями "Переводы" и "Наличные" 
(только если они явно не прописаны в таблице матчинга категорий) - 
они подлежат ручному разбору через таблицу `manual_transaction`.

### Альтернативный флоу работы
В случае невозможности сматчить транзацкии в соотвествии с данными из таблиц
- `account_matching`,
- `category_matching`,
- `currency_matching`, 

следует добавить информацию о таких транзакциях в таблицу `transaction`, которая полностью повторяет 
структуру таблицы `transaction`, но ни одно поле в ней не является в ней обязательным, 
а также есть флаг фиксирования записи в таблице `transaction`. 

Добавлению в `manual_transaction` подлежат только записи, которых нет по ключу:
- bank_id
- type
- category_id (nullable)
- date
- sum
- account_id (nullable)

При наличии полного совпадения по этим полям запись не добавляется.

После ручного внесения изменений и последующей проверки в рамках работы шага,
записи из `manual_transaction` попадают в `transaction` с отметкой о добавлении в последнюю - 
такие записи более не будут экспортироваться `transaction`.


А МОЖЕТ ОТКАЗАТЬСЯ НАФИГ ОТ manual_transaction?
Просто сделать account_id nullable и не разрешать импорт таких записей в итоговый файл.